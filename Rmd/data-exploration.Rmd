---
title: "Vernal Pool Data Exploration"
author: "Vanessa Salgado"
date: "July 1, 2024"
output: html_document
---

```{r}
library(tidyverse)
library(leaflet)
library(tmap)
library(sf)
library(terra)
library(here)
library(stringr)
library(lubridate)
library(janitor)
```

# Data Exploration 
## Importing Data 

#-----------------------------------------------------------
#              Data Cleaning
#-----------------------------------------------------------
* vegetation zone : edge, transition, bottom
* species: scientific name (sci_lowercase,NA, log, algae, moss, mulch_woodchip)
  *  are these just plants or are there animals 
  * 168 uniqye different types of species 
  * 4965 : NA
* unlisted species: ?vaires a lot, should we include these
* type: "native"    "nonnative" "unknown"   "other"   


* TO DO: 
- species names?
- 

```{r, percent_cover_combined}
# percent_cover_combined_TJ
# loation, poolID, 

percent_cover <- read_csv(here("data", "percent_cover_combined_JT_date_fixed.csv")) %>% 
  # change column names to snake case
  clean_names() %>% 
  # unselect name identifiers 
  dplyr::select(-monitor_names, -creator, -creation_date,-edit_date,-editor, -creation_date ) %>% 
  # create a new column with location and pool_id
  mutate(location_pool_id = paste(location, pool_id, sep = "_")) %>% 
  mutate(location_pool_id = str_replace_all(location_pool_id, ' ', '_')) %>% 
  # change date using lubridate
  mutate(monitoring_date = lubridate::mdy(monitoring_date))

# convert decimla dates to dates in lubridate 

#-----------------------------------------------------------
#              SCRATCH 
#-----------------------------------------------------------

# count species types
percent_cover %>% 
  group_by(species ) %>% 
  summarize(count = n()) %>% 
  arrange(count)

# count locations types
percent_cover %>% 
  group_by(location) %>% 
  summarize(count = n()) %>% 
  arrange(count)


# columns
colnames(percent_cover)


# delsol _ delsolcamino corto <- combined 
# letter for delsol
# number fo camino 

# 10 unique locations for percent cover 
# "delsol_caminocorto" "ellwood_mesa"       "manzanita_village"  "more_mesa"          "ncos" 
# "north_parcel"       "sierra_madre"       "south_parcel"       "storke_ranch"       "west_campus"       
unique(percent_cover$location)

# 48 uniqu e
# mix of char, strings, ints, years, ordered numbers 
unique(percent_cover$pool_id)

# 82 unique location_pool_id 
unique(percent_cover$location_pool_id)


# create a new column - poolID and location 
percent_cover_clean <- percent_cover %>% 
  group_by(location, pool_id) 

str(percent_cover)
```

## HydroData 

* x, y : are all the same just slighly off 
*  1,021 rows
* drop irrelavent columsn

```{r}

hydro_data <- read_csv(here("data", "hydro_corrected.csv")) %>% 
  clean_names() %>% 
  rename(pool_id = vernal_pool_name_or_id, hydro_date = date) %>% 
  dplyr::select(-creator,-edit_date,-editor, -creation_date, -global_id, -monitor_name,-object_id ) %>% 
  mutate(location_pool_id = paste(location, pool_id, sep = "_")) %>% 
  mutate(location_pool_id = str_replace_all(location_pool_id, ' ', '_'))


str(hydro_data)


#  finds all rows in x that aren't in y.
setdiff(unique(percent_cover$pool_id), unique(hydro_data$pool_id))
# "I" ,  "J" , "K" , "L" , "Anacapa East" , "Anacapa West" , "Chumash"   

# not all veral pools have hydrology data 
setdiff( unique(hydro_data$pool_id), unique(percent_cover$pool_id))
# "Created pool by trees" , "Main"        

unique(hydro_data$vernal_pool_name_or_id)

hydro_data %>% 
  group_by(pool_id, location) %>% 
  summarize(count = n())
  

# water_level_in by pool_id


```

## Meta Data vp_polygons 
```{r, meta data}
vp_polygons <- read_csv(here("data", "vp_polygons.csv")) %>% 
  clean_names()

# poolID might be different from the rest of the csv
# last 3 measurentns are in ft, ft, meters 
vp_polygons
```

* combine pc_abiotic_df with hydro_corrected
* make a new column with poolID and location 
* vernal Pool Name is the same in both pc_abiotic_df and hydro

```{r, pc_abiotic}
# columns up to K are relavent, measurements from vp_polygons
pc_abiotic_data <- read_csv(here("data", "pc_abiotic_df.csv")) %>% 
  clean_names() %>% 
  # drop anything after depth(keep location throught depth)
  select(location:depth_cm) %>% 
  mutate(location_pool_id = paste(location, pool_id, sep = "_")) %>% 
  mutate(location_pool_id = str_replace_all(location_pool_id, ' ', '_'))
  # drop anything after depth(keep location throught depth)
  

unique(pc_abiotic_data$location_pool_id)
```

# Vernal Pools Shapefile
```{r}
# ------------------------------------
# Fixing location names in vernal pools
# ------------------------------------

# Function to convert a string to snake case
to_snake_case <- function(x) {
  x <- str_to_lower(x)           # Convert to lowercase
  x <- str_replace_all(x, " ", "_")  # Replace spaces with underscores
  x <- str_replace_all(x, "-", "_")  # Replace hyphens with underscores
  x <- str_replace_all(x, "[^a-z0-9_]", "") # Remove any characters that are not letters, numbers, or underscores
  return(x)
}

# ------------------------------------
# Fixing location names in vernal pools
# ------------------------------------
# Read the shapefile
vernal_pools<- st_read(here("data", "VernalPools_Monitored2019", "VernalPools_Monitored2019.shp")) %>% 
  clean_names() %>%
  # assuming I made the correct name conversion
 mutate(location = case_when(
    location == "Del Sol" ~ "delsol_caminocorto",
    location == "CC" ~ "delsol_caminocorto",
    location == "WCB" ~ "west_campus",
    location == "NP" ~ "north_parcel",
    location == "Storke" ~ "storke_ranch",
    location == "Sierra Madre Housing" ~ "sierra_madre",
    location == "Ellwood" ~ "ellwood_mesa",
    TRUE ~ location )) %>% 
  mutate(pool_id = case_when(
    pool_id == "Santa Barbara Vernal Pool" ~ "Santa Barabra",
    pool_id == "Santa Catalina Vernal Pool" ~ "Santa Catalina",
    pool_id == "Santa Cruz Vernal Pool" ~ "Santa Cruz",
    pool_id == "San Miguel Vernal Pool" ~ "San Miguel",
    pool_id == "Santa Rosa Vernal Pool" ~ "Santa Rosa",
    TRUE ~ pool_id )) %>% 
  mutate(location = sapply(location, to_snake_case),            # Apply to_snake_case to 'location' column
         location_pool_id = paste(location, pool_id, sep = "_")) %>%  # Create new column combining 'location' and 'pool_id'
  mutate(location_pool_id = sapply(location_pool_id, to_snake_case)) %>% 
  mutate(location_pool_id = paste(location, pool_id, sep = "_")) %>% 
  mutate(location_pool_id = str_replace_all(location_pool_id, ' ', '_')) %>% 
  select(-global_id)

# 10 unique locations for percent cover 
# "delsol_caminocorto" "ellwood_mesa"       "manzanita_village"  "more_mesa"          "ncos" 
# "north_parcel"       "sierra_madre"       "south_parcel"       "storke_ranch"       "west_campus"  

# unique location in hydrology 
# unique(hydro_data$location)
# delsol_caminocorto
# ellwood_mesa
# manzanita_village
# more_mesa
# ncos          
# north_parcel
# sierra_madre
# south_parcel
# storke_ranch
# west_campus

# unique location in vernal_pools
# ? west_campus= WCB
# ? north_parcel= NP
# ? stork_ranch = "Storke"
# delsol_caminmocorto = "Del Sol"             
# ?delsol_caminocorto = CC
# ellwood_mesa = Ellwood Mesa (Done)
# more_mesa = More Mesa (done)
# south_parcel = South Parcel (done)  
# ?sierra_madre = Sierra Madre Housing
# ?manzanita_village = Manzanita Village(done)
# ncos= NCOS (done)
# ellwood_mesa = Ellwood  Mesa
# ?Ellwood
length(unique(vernal_pools$location))
# 11

length(unique(vernal_pools$pool_id))
# 67 

length(unique(vernal_pools$location_pool_id))
# 92


```
# TO DO: Vernal Pool Cross Section Shapefile


#-----------------------------------------------------------
#        Joining Data 
#-----------------------------------------------------------



```{r}
library(tidylog)

# CLEANING FOR JOINING
View(hydro_data)

View(pc_abiotic_data)


hydro_data_2 <- hydro_data %>% 
  select(-object_id, -global_id, -x, -y)

#pc_abiotic_data_2 <- pc_abiotic_data



# TO DO : combine hydrology and abiotic 
hydro_abiotic_join <- right_join(hydro_data, pc_abiotic_data, by = "global_id")


# TO DO : combine hydrology and shape files
full_joined_data <- hydro_data %>% 
  full_join(pc_abiotic_data, by = join_by(location_pool_id)) %>% 
  full_join(vernal_pools, by = join_by(location_pool_id))

# notes: clean the date column

colnames(hydro_data)

colnames(pc_abiotic_data)

```



#-----------------------------------------------------------
#         Mapping shapes / polygons
#-----------------------------------------------------------


```{r}
st_crs(vernal_pools)
# PROJCRS["NAD83(2011) / California zone 5 (ftUS)",
# Basic plot

plot(vernal_pools["Pool_ID"])

# location and pool ID are very differenct than the hydro data

# preminary plot 

# WGS84 CRS (this is the CRS used by leaflet):
vernal_pools <- vernal_pools %>% st_transform(4326)

leaflet(data = vernal_pools) %>% 
  addproviderTiles(Stadia.AlidadeSatellite) %>% 
  addPolygons() %>% 
  addPolylines()


unique(vernal_pools$gps_date)
```

#-----------------------------------------------------------
##       Write Date 
#-----------------------------------------------------------

```{r, save_date}


write_csv(pc_abiotic_data, here("dashboard_data", "pc_abiotic_data.csv"))
write_csv(hydro_data, here("dashboard_data", "hydro_data.csv"))
write_csv(percent_cover, here("dashboard_data", "percent_cover_data.csv"))
# how to save a shp file? 
#write_csv(vernal_pools, here("dashboard_data", "vernal_pools_monitored"))
st_write(vernal_pools, here("dashboard_data","vernal_pools_monitored.shp"))
write_csv(vp_polygons, here("dashboard_data", "vp_polygons_data.csv"))

# new joined dataset
wrtie_csv(full_joined_data, here("dashboard_data", ""))



```


#-----------------------------------------------------------
##       Data Visualization for Hydrology 
#-----------------------------------------------------------




For transect: 
* total percent native/non-native cover on y axis
* profile of the vernal pool should give you a bell curve 
* toggle by species 

### Hydro Graph:  
* not a transect
* water on y, week on x 

### vegetation
* list of all the species for that pool 
* ranked by abundance - total native percent cover average of all the quadrats 

### Species list pop up per pool 
* 
* 

## Active /Non Active 
* vernal pool cross sections dataset 
* before changing there are 55 active pools, but there are supposed to be 
* total: 92, when there are supposed to be 70
* unique count of unqiue count of 

